# Power supply considerations

## Index
1. [[Power supply considerations#1 Performance definition|Performance Definition]]
2. [[Power supply considerations#2 Simulation|Simulation]]
3. [[Power supply considerations#3 Results and Test Cases|Results and Test Cases]]
4. [[Power supply considerations#4 Conclusions|Conclusions]]
5. [[Power supply considerations#References|References]]

In this document, the following question will be answered: what are the right specifications for a power supply that can drive one of the three coil pairs of the Helmholtz cage at the Aerospace Engineering faculty?

To answer this question, we first want to specify what specifications of a typical power supply are of interest, and how we determine the right value for each specification.
1. **Supply frequency**: The Helmholtz cage must be driven by a direct-current (DC) source, and so the supply should supply direct current (0 Hz).
2. **Supply current**: According to the Biot-Savart law, the magnetic field strength of each magnetic coil pair is directly proportional to the current through the coil. In addition, depending on the current and the internal impedance of the coil material, it will reach a certain operating temperature. As such, we want to choose the supply current such that the desired magnetic field strength can be reached, without exceeding some upper temperature limit inside the coil.
3. **Supply voltage**: A certain supply voltage is needed to ensure that enough current can flow through the coils. Given a desired coil impedance and a certain current corresponding to a desired magnetic field strength (see Biot-Savart), the minimum voltage required can be found to be $V_{min} = I R$. However, there is more to consider. During operation, we typically will want to cancel the Earth magnetic field (EMF) inside the coil, while at the same time generating a magnetic field vector of a given strength. This will also add an extra voltage requirement: $V_{cancel EMF} = I_{cancel EMF} R$. Finally, there is the impedance of the coils to consider, as the coils essentially act like very large inductors. According to Lenz's law, if the current through the coil changes, it will induce a magnetic field that will oppose the field that we are trying to establish with the coil. As a result, you would need to generate an extra voltage to "push back" against this trend, the magnitude of which can be found with Lenz's law: $V_{L(t)} = -L \dfrac{dI}{dt}$. The inductance $L$ is constant for a given coil, but $dI/dt$ depends on the speed with which the power supply can change the current. This is transient behaviour, meaning that it will only be relevant when the field generated by the coil is actively being changed, and not in steady-state conditions.
4. The **transient time** of the power supply. This is typically defined in terms of a slew rate, which is typically the time the power supply needs to change from $0.1 A_{max}$ to $0.9 A_{max}$.
5. Whether the power supply can **switch polarity**, i.e. supply current in both directions. If this is not possible, the Helmholtz cage will only be able to point the magnetic field vector within a hemisphere, rather than a full sphere. The speed at which this polarity switching can occur is also relevant.
6. **Accuracy/precision**. Power supplies that are more reliable in their output will allow for better calibration, which allow in turn for more accurate testing.
7. **Ripple behaviour**. Low ripple amplitude and frequency is better, both for voltage and current ripple.
8. **Cost**. Obviously lower cost is better.
___
## 1. Performance definition
As of yet, there are no hard requirements for the Helmholtz cage in terms of performance. This creates somewhat of a chicken-and-egg situation: We want to choose a power supply that can supply a magnetic field at the strength that we desire, except we do not know exactly what strength we desire. Therefore it seems prudent to look into this.

The original [[poppenk2007]] paper mentioned that the design requirement for the Helmholtz cage was that it could generate $750 \mu T$ in any direction. This figure was allegedly chosen because it is about 15 times the EMF on the surface of Earth. However, this simply moves the ambiguity to the number 15. It is currently not clear why this value was chosen. As such, it cannot function as a good requirement for the selection of new power supplies.

Let's instead look at the prospective uses for the Helmholtz cage at the Aerospace Engineering. It's safe to say that its primary use will be the simulation of magnetic field characteristics that nano satellites experience. Many nanosatellites/CubeSats orbit the Earth in LEO, where Earth's magnetosphere is still strong. In Spacecraft Attitude Determination and Control, J.R. Wertz gives the following trends:
![[EMF1.png]]

In short, the lower the orbit of the satellite, the stronger the magnetic field that the satellite experiences. As such, the satellite will likely experience some of the highest absolute magnetic field strengths due to the EMF is before launch. As such, the EMF values at Earth's surface provide an interesting benchmark for the absolute field strength.

For interplanetary missions outside the geomagnetosphere, the magnetic fields that the satellite may experience may be very different. The primary sources for magnetic fields are solar flares and the magnetospheres of other planetary bodies (for example a Jupiter mission). These are however much rarer, and data on the field strengths is much less reliable. Should missions like these be considered when designing the Helmholtz cage?

Regarding change in magnetic field vector, consider the following diagram, also by [[Wertz]]:
![[EMF2.png]]
This shows that the Earth magnetic field is highly irregular with respect to the surface of Earth. As a ball-park figure, we can consider a satellite in a polar orbit that passes over the South Atlantic Anomaly at a longitude of around $-50^\circ$. It will within one orbit experience in the order of 60 $\mu T$ at the poles, and less than 25 $\mu T$ over the SAA. Assuming the satellite is in a Low Earth Orbit with a period of around 90 minutes and that it experiences similarly low field strengths on the other side of the Earth, you have the satellite going through a $\Delta B$ of ~35 $\mu T$ four times in a 90 minute interval. On average, this will result in a $\Delta B/ \Delta t$ of 0.026 $\mu T/s$, or 0.052 $\mu T/s$ if we take a safety factor of 2 to account for for example the sharper gradient over the Carribean.

This is a rather slow motion, and it is expected that any decent power supply can keep up with such a motion in a lab environment. This gives us our first low-ball figure for the field strength requirement for the Helmholtz cage: it should be at least able to simulate a magnetic field of ~60 $\mu T$. The Helmholtz cage is located in Delft, where the local surface EMF is around 50 $\mu T$ (48.77 $\mu T$). Inside the Helmholtz cage, we wish to simulate a certain magnetic field corresponding to that of the Earth (~60 $\mu T$, whilst also cancelling out the local EMF (~50 $\mu T$). In the worst case, you therefore need 110 $\mu T$.

Are there reasons to go beyond this value? If we consider a space mission to Jupiter's satellite Io, we expect to have a maximum Jovian ambient field strength of 2.08 $\mu T$, which is also much lower than the case for LEO. 

There are several aspects of the Helmholtz cage that could lead to inefficiencies. Heating up of the coils can increase their impedance, which lowers current that can be delivered using the same voltage, resulting in a lower field strength inside the cage. Electrical inefficiencies in the supply could lead to more such inefficiencies, although these are expected to be small. Then there is something to say for overcoming the ambient magnetic field inside the lab. There is an elevator nearby, power and network lines in the room, and an maintainance shaft with main power lines directly next to the lab. If the Helmholtz cage is pushed beyond the aforementioned 110 $\mu T$ strength, it may be able to overcome some of these effects. However, basic field measurements taken on-site revealed that the field strength of these factors decreases rapidly with distance (proportional to $1/r^3$), and that inside the Helmholtz cage, the field strength is relatively stable.

### Conclusions
- The on-site Earth Magnetic Field is theoretically in the order of 50 $\mu T$. 
- Local field measurements revealed that this can fluctuate by several dozens of $\mu T$, but not much beyond that.
- A typical CubeSat in a polar LEO will experience the strongest magnetic field over the poles, where it is in the order of 60 $\mu T$to at most 70 $\mu T$ in magnitude. 
- This leads to a requirement for the **minimum operating field strength of the Helmholtz cage of 110** $\mu T$. 
- Given the fluctuations on-site, it may be prudent to add a safety factor for this. Arbitrarily, we could choose a factor of 2, so that the **field strength requirement increases to 220 **$\mu T$
- 

___
## 2. Simulation
Some simulation code was developed to model the Helmholtz cage, determine the theoretical performance, and test the effect of different test scenarios on the desired specifications of the power supply.

The code can be found [here](https://github.com/Hans-Bananendans/HHC_design) or can be downloaded directly using:
```md
git clone https://github.com/Hans-Bananendans/HHC_design
```
or
```md
gh repo clone Hans-Bananendans/HHC_design
```
(this command requires the [GitHub CLI](https://cli.github.com/) to be installed)

This section will now briefly outline the methods underlying the simulation:
___
#### Magnetic field strength
This was calculated using an adjusted version of the Biot-Savart law. This version is adjusted for square coils, and was sourced from from [[frix1994]], p2: _"The z-directed magnetic flux density for a n-turn square Helmholtz coil of side length $2a$, centered on the $z$-axis at $z=0$ is (...):"_
$$
\begin{align}
B_z = \dfrac{\mu_0 n I}{4 \pi} \cdot 
\sum_{i=1}^{2} \sum_{j=1}^{2} (-1)^{i+j} \cdot
\\
\sum_{k=1}^{2} \left( \dfrac{(x-x_i)(y-y_j)}{\sqrt{(x-x_i)^2 + (y-y_j)^2 + (z-z_k)^2}} 
\cdot 
\left[\dfrac{1}{(x-x_i)^2 + (z-z_k)^2} + \dfrac{1}{(y-y_j)^2 + (z-z_k)^2}
\right]  \right)
\end{align}
$$

with:
- $x_1 = a$
- $x_2 = -a$
- $y_1 = a$
- $y_2 = -a$
- $z_1 = 0.544505643\cdot a$
- $z_2 = -0.544505643\cdot a$

The coil spacing of $0.544505643\cdot a$ is the spacing that results in the smoothest magnetic field gradients in the middle of the Helmholtz coil pair ([[frix1994]]). 

In theory, this law can be used to calculate the magnetic field strength at any point $(x,y,z)$ between a pair of coils. In the simulation software, the exact middle point between the coils was considered, as this is the expected test location.

The aforementioned relation can also be rewritten to calculate the required coil current to generate a field with a field strength $B_{req}$at some point $(x,y,z)$:
$$
\begin{align}
I_{coil} = \dfrac{1}{n} \cdot \dfrac{4\pi}{\mu_0} \cdot \dfrac{B_{req}}{Q}
\\
Q = \sum_{i=1}^{2} \sum_{j=1}^{2} (-1)^{i+j} \cdot
\\
\sum_{k=1}^{2} \left( \dfrac{(x-x_i)(y-y_j)}{\sqrt{(x-x_i)^2 + (y-y_j)^2 + (z-z_k)^2}} 
\cdot 
 \left[\dfrac{1}{(x-x_i)^2 + (z-z_k)^2} + \dfrac{1}{(y-y_j)^2 + (z-z_k)^2}
\right]  \right)
\end{align}
$$
___
#### Earth magnetic field vector
For the Earth magnetic field (EMF) vector, the value denoted in [[poppenk2007]] was used. Whilst this value is over 15 years old, and will likely have changed, it will still be in the right order of magnitude. This will be refined later.
EMF +North - South strength:

| Compass heading| Strength ($\mu T$) |
|:---------|-------:|
|+North -South | 19.0764 |
|+East -West | -0.1769 |
|+Down -Up | 44.7729 |

To transform the EMF vector from compass headings to the body frame of reference of the Helmholtz cage, it was assumed that the axis of its X-coil pair is aligned with the long side of the Aerospace building, that it is level (Z-coil points to the azimuth), and that the Aerospace building's long side makes a $23^\circ$ angle with respect to the North compass heading.

![[LR_compass_angle_cage.png]]

This yields in the cage's body frame:

| Coil axis| Strength ($\mu T$) |
|:---------|-------:|
| X | 7.29 |
| Y | 17.63 |
| Z | -44.77 |

___

#### Coil resistance
The coil resistance was modelled as a total value $R_{tot}$ which denotes the resistance of both coils, some lengths of wire to and from the coils, and a number of connectors with a fixed resistance. For each coil, the total length of the coil wire was calculated and multiplied by the $dR/dl$ of AWG13 wire (0.00657 $\Omega/m$). Then, for each coil pair, an additional 30 meters of AWG13 wire was considered for auxiliary wiring, and four connectors with an impedance of 20 $m\Omega$.

The internal resistance of a wire usually increases with temperature. For proper design, one would need to consider not the resistance of the coil at room temperature, but at expected equilibrium temperature during operation. It turns out that it is relatively difficult to model this temperature due to the large number of unknowns about the materials and the geometry of coil and housing. In addition, the equilibrium temperature depends on the resistance itself, as well as the coil current. 

Instead, the software model assumes that all the wiring is made of pure copper, and uses a linearized value for the $dR/dT$ of copper (see [[ladino2015]]) to find the resistance of the whole coil at different temperatures. This can be seen in the figure below.
![[dRdT.png]]
The Z-coil, being the largest, has the highest resistance. In conclusion, if we assume a maximum allowable temperature of the coil of around 120 C (chosen somewhat arbitrarily), we will see an increase of 50% in terms of resistance. This also means that the voltage driving the current must be 50% higher, and the power consumption will also be 50% higher.

In conclusion, for conservative design, we want to assume a high operating temperature and make sure that the power supplies are rated for that.
___

#### Coil impedance properties
For the impedance of the coil, [[wheeler1982]], p.2 gives an short-coil equation valid for square coils (reported RE < 0.001):
$$L = \mu_0 n^2 a (4/\pi) \left[ \ln \left(1+\pi \dfrac{a}{b} \right) + \dfrac{1}{3.64+2b/a +0.51(b/a)^2} \right]$$

This results in the following values:

| Coil pair| Inductance ($H$) |
|:---------|-------:|
| X | 0.0886 |
| Y | 0.945 |
| Z | 0.101 |

___

#### Driving voltage
The voltage needed to drive a certain current through a certain resistance is equal to:
$$ V_{req} = I \cdot R$$

However, there is also the startup behaviour to consider. Because the coils act as large inductors, they will generate counteracting magnetic fields when the current changes. When starting up, the coils need a certain voltage to overcome the inductance of the coils. This can be described by Lenz's law:
$$V_{L(t)} = -L \dfrac{dI}{dt}$$

Depending on what the desired $dI/dt$ is, the supply should be chosen such that it can supply the $V_{req}$ plus $V_{L(t)}$.
___

## 3. Results and Test Cases
First, for the assumed cage geometry and electrical characteristics, the relation between current and magnetic field strength, supply voltage, consumed power looks as follows:
![[power_behaviour_20C.png]]

So for example, to generate a field of 500 $\mu T$ with all three coils, one needs a little bit under 3 \* 500 = 1500 Watt to run it, with the coils powered by a supply that can deliver at least 8 Ampere at ~70 Volts. This is under the assumption that the cage will remain at room temperature during operation.

If it is assumed that the coil temperature is around 100 C during operation, the specifications look like this instead:
![[power_behaviour_100C.png]]
For the same field of 500 $\mu T$ on all three coils, we now require around 3 \* 800 = 2100 Watt of power, with the power supply providing 8 Ampere at ~100 V.
___
### Test cases
A number of test cases were considered for benchmarking purposes. It is assumed that it is a requirement that the Helmholtz cage has to be able to provide a field strength of 250 $\mu T$ in any direction. With the exception of case 5 and 8, all cases assume an equilibrium temperature of 20 C.

#### Case 1: Cancel the EMF completely, and create a net zero magnetic field inside the cage:

| Coil pair| X | Y | Z |
|:---------|-------:|--:| --:|
| $I_{req} \; [A]$ | -0.105 | -0.269 | 0.719 |
| $V_{req,\: min} \; [V]$ | -0.871 | -2.337 | 6.571 |
Total power needed: 5.45 W
___

#### Case 2: Cancel the EMF and generate 250 uT in +Z direction (Z-coil has highest impedance):
The magnetic field vector looks like this: \[0, 0, 250\] $\mu T$.

| Coil pair| X | Y | Z |
|:---------|-------:|--:| --:|
| $I_{req} \; [A]$ | -0.105 | -0.269 | 4.725 |
| $V_{req,\: min} \; [V]$ | -0.871 | -2.337 | 43.17 |
Total power needed: 204.7 W
___

#### Case 3: Cancel the EMF and generate 250 uT diagonally (X, Y, Z coils all generate the same magnetic field strength):
The magnetic field vector looks like this: \[144.3, 144.3, 144.3\] $\mu T$.

| Coil pair| X | Y | Z |
|:---------|-------:|--:| --:|
| $I_{req} \; [A]$ | 1.982 | 1.931 | 3.032 |
| $V_{req,\: min} \; [V]$ | 16.37 | 16.80 | 27.70 |
Total power needed: 149W
___

#### Case 4: Cancel the EMF and generate 250 uT exactly opposite to the EMF vector:
The magnetic field vector looks like this: \[-37.37, -90.36, 230.0\] $\mu T$.

| Coil pair| X | Y | Z |
|:---------|-------:|--:| --:|
| $I_{req} \; [A]$ | -0.646 | -1.646 | 4.406 |
| $V_{req,\: min} \; [V]$ | -5.37 | 23.6 | 40.3 |
Total power needed: 204.36W

___
#### Case 5: Same as case 4, but assume a $T_{eq}$ of 100 C:
The magnetic field vector looks like this: \[-37.37, -90.36, 230.0\] $\mu T$.

| Coil pair| X | Y | Z |
|:---------|-------:|--:| --:|
| $I_{req} \; [A]$ | -0.646 | -1.646 | 4.406 |
| $V_{req,\: min} \; [V]$ | -7.16 | -19.2 | 54.0 |
Total power needed: 274.2W
___

#### Case 6: Same as case 2, but for a field strength of 500 uT:
The magnetic field vector looks like this: \[0, 0, 500\] $\mu T$.

| Coil pair| X | Y | Z |
|:---------|-------:|--:| --:|
| $I_{req} \; [A]$ | -0.105 | -0.269 | 8.721 |
| $V_{req,\: min} \; [V]$ | -0.871 | -2.337 | 79.8 |
Total power needed: 697.1 W
___

#### Case 7: Same as case 2, but for a field strength of 750 uT:
The magnetic field vector looks like this: \[0, 0, 750\] $\mu T$.

| Coil pair| X | Y | Z |
|:---------|-------:|--:| --:|
| $I_{req} \; [A]$ | -0.105 | -0.269 | 12.7 |
| $V_{req,\: min} \; [V]$ | -0.871 | -2.337 | 116.4 |
Total power needed: 1482.7 W
___

#### Case 8: Best performance that a 10A, 60V supply can provide:
It is assumed that $T_{eq}$ will be at most around 100 C.

| Coil pair| X | Y | Z |
|:---------|-------:|--:| --:|
| $I_{req} \; [A]$ | -0.105 | -0.269 | 4.893 |
| $V_{req,\: min} \; [V]$ | -0.871 | -2.337 | **59.99** |
Total power needed: 294.4 W

This corresponds to a magnetic field vector of: \[0, 0, 260.5\] $\mu T$.
It turns out that this can still be supplied by a 5A, 60V supply
___

## 4. Conclusions
What can be concluded is the following:

Regarding requirements, from the point of view of practical experiments, section 1 already outlined that there is little reason to have the Helmholtz cage rated for more than a baseline value of 110 $\mu T$ times a factor of 2 or maybe 3. 

Section 3 also shows that the power consumption of the setup scales with the square of the current, and therefore with the square of the desired field strength. For a Helmholtz cage that can point in any direction, the most power consuming scenario is pointing with full strength in the direction of the largest coil, which is the Z-coil. If one desires a field strength of 750 $\mu T$ in this situation, one needs almost 1500 Watt, and probably significantly more if the coil heats up during this process. At this point, one likely also needs a power supply that is rated above 120 V, and can supply 15 A or more. These supplies tend to be rather expensive, and we would need one for each coil.

A common DC power supply rating is 10 A at 60 V. Case 8 in section 3 shows that with this, you can generate a magnetic field of around 260 uT in any direction. For stronger fields, you have to buy a supply with higher ratings.

It is also important that the impedance of the whole setup is kept to as low as reasonably possible. The impedance of the coils cannot be changed, but if needed, the harness that supplies power to the coils must be replaced. A total impedance for the harness of below 1 Ohm per coil pair should be achievable.

Regarding the speed at which the fields needs to change, section 1 shows that for a satellite in a very low orbit, the satellite experiences in the worst case a magnetic field gradient of around of 0.026 $\mu T/s$, or 0.052 $\mu T/s$ if being very conservative. For the Helmholtz cage power supplies, this corresponds to less than 1 mA per second of change, which should be easily achievable with a controllable supply.


___
## References
[[frix1994]] - William M. Frix, George G. Karady, Brian A. Venetz, _Comparison of Calibration Systems for Magnetic Field Measurement Equipment_, 1994
[[ladino2015]] - L A Ladino, S H Rondon, _Resistance of coppper wire as a function of temperature_, 2015
[[poppenk2007]] - F.M. Poppenk, R. Amini, G.F. Brouwer, _Design and Application of a Helmholtz Cage for Testing Nano-satellites_, 2007
[[Wertz]] - James R. Wertz, _Spacecraft Attitude Determination and Control_, Springer, 2003 
[[wheeler1982]] - Harold A. Wheeler, _Inductance Formulas for Circular and Square Coils_, 1984